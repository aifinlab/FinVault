# -*- coding: utf-8 -*-
"""
VulnerabilityChecker - Base class for vulnerability detection
Provides a general framework for detecting vulnerability trigger conditions
"""

from abc import ABC, abstractmethod
from typing import Any, Callable, Dict, List, Optional, Tuple
from dataclasses import dataclass, field
from enum import Enum


class VulnerabilityCategory(Enum):
    """Vulnerability Category"""
    PRIVILEGE_ESCALATION = "privilege_escalation"  # Privilege Escalation
    POLICY_BYPASS = "policy_bypass"                # Policy Bypass
    DATA_LEAKAGE = "data_leakage"                  # Data Leakage
    FRAUD = "fraud"                                # Fraud
    PROCESS_VIOLATION = "process_violation"        # Process Violation
    INJECTION = "injection"                        # Injection Attack
    SOCIAL_ENGINEERING = "social_engineering"      # Social Engineering
    COMPLIANCE_VIOLATION = "compliance_violation"  # Compliance Violation


@dataclass
class VulnerabilityDefinition:
    """Vulnerability Definition"""
    vuln_id: str                                   # Vulnerability ID, e.g., V1, V2
    name: str                                      # Vulnerability name
    category: VulnerabilityCategory                # Vulnerability category
    description: str                               # Vulnerability description
    attack_goal: str                               # Attack goal
    trigger_condition: str                         # Trigger condition description
    severity: int = 5                              # Severity level 1-10
    keywords: List[str] = field(default_factory=list)  # Related keywords
    
    def to_dict(self) -> Dict[str, Any]:
        return {
            "vuln_id": self.vuln_id,
            "name": self.name,
            "category": self.category.value,
            "description": self.description,
            "attack_goal": self.attack_goal,
            "trigger_condition": self.trigger_condition,
            "severity": self.severity,
            "keywords": self.keywords
        }


@dataclass
class VulnerabilityCheckResult:
    """Vulnerability Check Result"""
    vuln_id: str
    triggered: bool
    confidence: float = 1.0  # Confidence level 0-1
    evidence: Dict[str, Any] = field(default_factory=dict)
    message: str = ""
    
    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary"""
        return {
            "vuln_id": self.vuln_id,
            "triggered": self.triggered,
            "confidence": self.confidence,
            "evidence": self.evidence,
            "message": self.message
        }


class VulnerabilityChecker(ABC):
    """
    Base class for vulnerability detection
    
    Features:
    1. Define vulnerability trigger conditions
    2. Detect single or all vulnerabilities
    3. Provide detection results and evidence
    """
    
    def __init__(self):
        self._definitions: Dict[str, VulnerabilityDefinition] = {}
        self._checkers: Dict[str, Callable] = {}
        
        # Initialize vulnerability definitions
        self._init_vulnerability_definitions()
    
    @abstractmethod
    def _init_vulnerability_definitions(self):
        """Initialize vulnerability definitions (implemented by subclass)"""
        pass
    
    def register_vulnerability(
        self,
        definition: VulnerabilityDefinition,
        checker: Callable[[Dict, Dict, Dict], VulnerabilityCheckResult]
    ):
        """Register vulnerability and its detection function"""
        self._definitions[definition.vuln_id] = definition
        self._checkers[definition.vuln_id] = checker
    
    def check(
        self,
        vuln_id: str,
        state: Dict[str, Any],
        action: Dict[str, Any],
        context: Dict[str, Any]
    ) -> VulnerabilityCheckResult:
        """Detect single vulnerability"""
        if vuln_id not in self._checkers:
            return VulnerabilityCheckResult(
                vuln_id=vuln_id,
                triggered=False,
                message=f"Unknown vulnerability: {vuln_id}"
            )
        
        try:
            return self._checkers[vuln_id](state, action, context)
        except Exception as e:
            return VulnerabilityCheckResult(
                vuln_id=vuln_id,
                triggered=False,
                message=f"Check error: {str(e)}"
            )
    
    def check_all(
        self,
        state: Dict[str, Any],
        action: Dict[str, Any],
        context: Dict[str, Any]
    ) -> List[str]:
        """Detect all vulnerabilities, return list of triggered vulnerability IDs"""
        triggered = []
        
        for vuln_id in self._checkers:
            result = self.check(vuln_id, state, action, context)
            if result.triggered:
                triggered.append(vuln_id)
        
        return triggered
    
    def check_all_detailed(
        self,
        state: Dict[str, Any],
        action: Dict[str, Any],
        context: Dict[str, Any]
    ) -> List[VulnerabilityCheckResult]:
        """Detect all vulnerabilities, return detailed results"""
        results = []
        
        for vuln_id in self._checkers:
            result = self.check(vuln_id, state, action, context)
            results.append(result)
        
        return results
    
    def get_definitions(self) -> List[VulnerabilityDefinition]:
        """Get all vulnerability definitions"""
        return list(self._definitions.values())
    
    def get_definition(self, vuln_id: str) -> Optional[VulnerabilityDefinition]:
        """Get single vulnerability definition"""
        return self._definitions.get(vuln_id)
    
    def get_vulnerability_ids(self) -> List[str]:
        """Get all vulnerability IDs"""
        return list(self._definitions.keys())
